# FJJLV PDF Reader - Copilot Instructions

## Project Overview
React 18 SPA for viewing PDFs with draggable annotation stamps. Chinese-only UI. Client-side only (no backend) - all state persists to localStorage keyed by PDF content hash.

## Tech Stack
- **React 18.2** with StrictMode + hooks-only patterns
- **Vite 5** (port 3000, auto-open browser)
- **react-pdf 10.3** + **pdfjs-dist 5.4.530** for PDF rendering
- **React Router DOM 6.21** - 2-page SPA structure
- **ES Modules only** (`"type": "module"` in package.json)
- **Chinese (zh-CN)** for all UI text, comments, and documentation
- **localStorage** for all persistence (no backend/database)

## Architecture & Data Flow

### Core Structure
```
src/
  App.jsx              # Router root: PdfProvider wraps BrowserRouter
  main.jsx             # Entry: ReactDOM.createRoot() + StrictMode
  
  pages/
    ImportPage.jsx     # Route: "/" - file picker, computes pdfId via SHA-256
    ReaderPage.jsx     # Route: "/reader/:pdfId" - PDF viewer + stamp layer
  
  components/
    StampLayer.jsx     # Overlay container for current page stamps
    StampItem.jsx      # Draggable stamp with pointer events
    StampToolbar.jsx   # Fixed bottom-right toolbar with 3 stamp type buttons
    StampPanel.jsx     # Full-screen modal for stamp type panels (rhythm/form/tactile)
    RegionSelector.jsx # Form stamp region detection overlay (canvas-based CV)
    OnboardingOverlay.jsx  # First-time user guide overlay
  
  assets/
    rhythmStickers.js  # Prebuilt rhythm pattern visuals (steps√órepeats combinations)
  
  context/
    PdfContext.jsx     # Global state: currentPdf (pdfId + File object)
  
  utils/
    pdfHash.js         # SHA-256 hash ‚Üí 24-char pdfId (Web Crypto API)
    stampStorage.js    # localStorage CRUD for stamps by pdfId
  
  types/
    stamp.js           # JSDoc typedefs (not TypeScript - pure JS project)
```

### Navigation Flow
1. **ImportPage** (`/`): User selects PDF ‚Üí computes SHA-256 hash (first 24 chars = pdfId) ‚Üí stores File in PdfContext ‚Üí navigates to `/reader/:pdfId`
2. **ReaderPage** (`/reader/:pdfId`): 
   - Guards: Validates pdfId exists and matches currentPdf.pdfId (redirects to ImportPage on mismatch)
   - Loads File from PdfContext, renders with react-pdf
   - Loads stamps + reader state (lastPage, lastZoom) from localStorage
   - Shows OnboardingOverlay on first visit (tracked via localStorage)
   - Displays stamps via StampLayer, allows adding/dragging stamps
   - Shows DebugPanel in dev mode (import.meta.env.DEV)
   - Shows DebugPanel in dev mode (import.meta.env.DEV)

### Data Model

**PDF Identity**: Each PDF uniquely identified by 24-char SHA-256 hash prefix ([pdfHash.js](src/utils/pdfHash.js#L9-L17))
```js
const pdfId = await computePdfId(file)  // "a1b2c3d4e5f6..." (24 chars)
```

**Stamp Structure** ([types/stamp.js](src/types/stamp.js)):

Uses **discriminated union** pattern with JSDoc:
```js
// Base properties (all stamps)
{
  id: "stamp_1234567890_xyz",      // Generated by Date.now() + random
  pdfId: "a1b2c3...",               // Links to PDF
  page: 5,                          // 1-indexed page number
  type: "generic" | "rhythm" | "form" | "tactile",
  x: 0.85,  y: 0.15,                // Normalized coords (0..1)
  createdAt: 1737555600000,
  payload: {}                       // Type-specific data
}

// RhythmStamp extends base with:
{
  type: "rhythm",
  payload: {
    steps: number,      // 2-8: rhythm pattern steps
    repeats: number,    // 2-12: pattern repetitions
    stickerId: string   // Reference to prebuilt asset
  }
}

// FormStamp extends base with:
{
  type: "form",
  payload: {
    promptId: string,           // Template identifier
    promptText: string,         // Display text (e.g., "What does it look like?")
    note?: string,              // Optional user note
    silhouette?: {              // Optional region boundary
      kind: 'none' | 'auto_placeholder' | 'manual_bbox',
      bbox?: { x, y, w, h }     // Normalized coords (0-1)
    }
  }
}

// TactileStamp extends base with:
{
  type: "tactile",
  payload: {
    gestureId: string,          // e.g., "tap", "press", "pinch"
    gestureEmoji: string,       // e.g., üëÜ, ‚úã, ü§è
    feelId?: string,            // Optional modifier
    feelEmoji?: string,         // e.g., üåµ, ‚òÅÔ∏è, üß±
    feelLabel?: string          // Short text label
  }
}
```

**Creating Stamps**:
- Generic: `createStamp({ pdfId, page, type: 'generic', x, y, payload: {} })`
- Rhythm: `createRhythmStamp({ pdfId, page, x, y, steps, repeats, stickerId })`
  - Auto-clamps steps to [2,8] and repeats to [2,12]
  - stickerId format: `rhythm_{steps}_{repeats}_{pattern}` (e.g., "rhythm_4_3_straight")
- Form: `createFormStamp({ pdfId, page, x, y, promptId, promptText, note?, bbox? })`
  - bbox is Silhouette object with normalized coords
- Tactile: `createTactileStamp({ pdfId, page, x, y, gestureId, gestureEmoji, feelId?, feelEmoji?, feelLabel? })`
  - See [stampStorage.js](src/utils/stampStorage.js) for all factory functions

**localStorage Keys**:
- `ltp_mvp::{pdfId}::stamps` ‚Üí `Record<number, Stamp[]>` (stamps grouped by page)
- `ltp_mvp::{pdfId}::reader_state` ‚Üí `{ lastPage: number, lastZoom: number }`
- `ltp_mvp::{pdfId}::onboarding_seen` ‚Üí `'1'` (string flag indicating onboarding completed)

### Stamp Types & UI Components

**Four Stamp Categories** ([StampToolbar.jsx](src/components/StampToolbar.jsx)):
- `rhythm` (‚ô™) - ËäÇÂ•èÊ†áËÆ∞ (Rhythm) - Orange (#f59e0b)
  - Shows badge with "steps√órepeats" (e.g., "4√ó3")
  - Gold border (3px) to distinguish from other types
  - Tooltip shows detailed payload info
- `form` (‚ñ°) - ÂΩ¢ÊÄÅÊ†áËÆ∞ (Form) - Blue (#3b82f6)  
- `tactile` (‚úã) - Ëß¶ËßâÊ†áËÆ∞ (Tactile) - Purple (#8b5cf6)
- `generic` (‚óè) - Default fallback - Green (#10b981)

**Rendering Logic** ([StampItem.jsx](src/components/StampItem.jsx)):
- `getTypeDisplay(stamp)` returns icon, color, label, and hasDetails flag
- Rhythm stamps with valid payload show `stamp-badge` with "steps√órepeats"
- Tooltip dynamically generated based on stamp type and payload

**UI Pattern**: Click toolbar ‚Üí Opens full-screen StampPanel ‚Üí Type-specific interfaces
- **StampToolbar**: Fixed bottom-right, toggles activePanel state
- **StampPanel**: Modal overlay with type-specific content:
  - **Rhythm Panel**: Sticker grid (steps 2-8 √ó repeats 2-12) from rhythmStickers.js
  - **Form Panel**: Prompt template selector + "Draw Region" button ‚Üí triggers RegionSelector
  - **Tactile Panel**: Gesture selector (6 gestures) + optional feel modifiers (6 feels)
- **RegionSelector**: Canvas-based computer vision overlay for Form stamps
  - Scans PDF canvas for high-contrast regions using edge detection
  - Displays bounding boxes with hover states
  - Returns normalized bbox coords (x, y, w, h) on selection
- User can add stamps via toolbar buttons OR quick "Ôºã Ê∑ªÂä†Ê†áËÆ∞" (creates generic at x=0.85, y=0.15)

### State Management Pattern

**Global State**: [PdfContext.jsx](src/context/PdfContext.jsx) provides `{ currentPdf, setPdf, clearPdf }`
- Used only to pass File object between routes (can't serialize File to localStorage/URL)
- Check if `currentPdf.pdfId === pdfId` in ReaderPage - redirect to ImportPage if mismatch

**Local State**: ReaderPage manages stamps via `useState` + `useEffect` sync with localStorage
- Load stamps: `useEffect(() => setStampsByPage(loadStamps(pdfId)), [pdfId])`
- Save stamps: `useEffect(() => saveStamps(pdfId, stampsByPage), [stampsByPage])`
- Pattern allows optimistic updates with auto-persistence

## Development Commands
```bash
npm install        # First time setup
npm run dev        # Start dev server ‚Üí http://localhost:3000 (auto-opens)
npm run build      # Production build ‚Üí dist/
npm run preview    # Preview production build locally
```

## Code Conventions

### Language Requirements
- **All UI text MUST be Chinese**: button labels, alerts, error messages, placeholders
- Example from [ReaderPage.jsx](src/pages/ReaderPage.jsx#L218-L220):
  ```jsx
  <button onClick={handleBack}>‚Üê ËøîÂõû</button>
  <h2>{currentPdf.file.name}</h2>
  <button onClick={handleAddStamp}>Ôºã Ê∑ªÂä†Ê†áËÆ∞</button>
  ```

### React Patterns (Strict)
- **Hooks only**: No class components
- **StrictMode**: Always enabled in [main.jsx](src/main.jsx)
- **React 18 API**: `ReactDOM.createRoot()` not `ReactDOM.render()`
- **JSX files**: Use `.jsx` extension (never `.js` for components)

### Styling Strategy
- **Per-component CSS**: [StampItem.jsx](src/components/StampItem.jsx) imports [StampItem.css](src/components/StampItem.css)
- **No CSS-in-JS**: Plain CSS files only (no styled-components)
- **Dark theme default**: CSS variables in [index.css](src/index.css)

### File Naming
- Components: `PascalCase.jsx` ([ImportPage.jsx](src/pages/ImportPage.jsx))
- Utilities: `camelCase.js` ([pdfHash.js](src/utils/pdfHash.js))
- Types: `camelCase.js` with JSDoc ([stamp.js](src/types/stamp.js))

## Critical Implementation Details

### PDF.js Worker Configuration
**MUST** set worker path before using react-pdf ([ReaderPage.jsx](src/pages/ReaderPage.jsx#L10)):
```js
import { pdfjs } from 'react-pdf'
pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`
```
**Why**: react-pdf requires separate worker thread for PDF parsing. Wrong path = infinite loading.

### Coordinate System for Stamps
Stamps use **normalized coordinates (0..1)** for resolution independence ([StampItem.jsx](src/components/StampItem.jsx#L11-L12)):
```js
const left = stamp.x * stageWidth   // Convert 0.85 ‚Üí 850px (if width=1000px)
const top = stamp.y * stageHeight
```
**Why**: PDF can be zoomed/resized. Storing absolute pixels would break on zoom changes.

### Drag Implementation Pattern
[StampItem.jsx](src/components/StampItem.jsx#L29-L42) uses **pointer events** (not mouse events):
```js
// On pointerdown: attach listeners to document (not element)
document.addEventListener('pointermove', handlePointerMove)
document.addEventListener('pointerup', handlePointerUp)

// On pointerup: remove listeners to prevent memory leaks
document.removeEventListener('pointermove', handlePointerMove)
document.removeEventListener('pointerup', handlePointerUp)
```
**Why**: Pointer events work on touch+mouse. Document-level listeners prevent losing drag when cursor leaves element.

### Stage Dimension Tracking
[ReaderPage.jsx](src/pages/ReaderPage.jsx#L88-L104) uses `ResizeObserver` to track PDF canvas size:
```js
useEffect(() => {
  const resizeObserver = new ResizeObserver((entries) => {
    const { width, height } = entries[0].contentRect
    setStageWidth(width)
    setStageHeight(height)
  })
  resizeObserver.observe(pdfStageRef.current)
  return () => resizeObserver.disconnect()
}, [])
```
**Why**: PDF size changes on zoom. Stamps need current dimensions to convert normalized coords to pixels.

### File Handling Best Practices
- **Never serialize File objects**: Use PdfContext to pass between routes
- **Validate file type**: `file.type === 'application/pdf'` ([ImportPage.jsx](src/pages/ImportPage.jsx#L15-L20))
- **Handle missing files**: ReaderPage shows fallback UI if `currentPdf.pdfId !== pdfId` ([ReaderPage.jsx](src/pages/ReaderPage.jsx#L107-L127))

### Reader State Persistence Pattern
[ReaderPage.jsx](src/pages/ReaderPage.jsx#L41-L93) uses a **load-first, save-later** pattern to prevent race conditions:
```js
const hasLoadedState = useRef(false)  // Prevents saving during initial load

// On mount: Load saved state, THEN mark as loaded
useEffect(() => {
  hasLoadedState.current = false
  // Reset to defaults first
  setPageNumber(1)
  setScale(1.0)
  // Load saved values
  const { lastPage, lastZoom } = JSON.parse(localStorage.getItem(storageKey))
  setPageNumber(lastPage)
  setScale(lastZoom)
  // NOW allow saves
  hasLoadedState.current = true
}, [pdfId])

// Save state: Only proceed if hasLoadedState.current === true
useEffect(() => {
  if (!hasLoadedState.current) return  // Skip initial render
  localStorage.setItem(storageKey, JSON.stringify({ lastPage, lastZoom }))
}, [pageNumber, scale])
```
**Why**: Without the flag, save-useEffect runs before load-useEffect completes, overwriting saved values with defaults.

## Common Tasks

### Adding a New Stamp Type
1. Update typedef in [types/stamp.js](src/types/stamp.js#L5)
2. Add case in [StampItem.jsx](src/components/StampItem.jsx#L17-L27) `getTypeDisplay()`:
   ```js
   case 'newType':
     return { icon: '‚òÖ', color: '#ec4899' }
   ```
3. Update [ReaderPage.jsx](src/pages/ReaderPage.jsx#L156) `handleAddStamp()` to use new type

### Debugging localStorage Issues
- Open DevTools ‚Üí Application ‚Üí Local Storage ‚Üí `http://localhost:3000`
- Keys: `ltp_mvp::{pdfId}::stamps`, `ltp_mvp::{pdfId}::reader_state`, `ltp_mvp::{pdfId}::onboarding_seen`
- Use DebugPanel (dev mode only): Draggable panel with "Dump localStorage" button + stamp inspector
- To reset: `localStorage.clear()` in console

### Working with react-pdf
- Component must be inside `<Document>` wrapper ([ReaderPage.jsx](src/pages/ReaderPage.jsx#L275-L289))
- `onLoadSuccess` callback provides `numPages` for pagination
- Use `loading`/`error` props for fallback UI (required for good UX)

## Vite-Specific Notes
- **Fast Refresh**: Component state preserved on file save
- **Port 3000**: Custom port in [vite.config.js](vite.config.js#L7) (not default 5173)
- **Environment variables**: Prefix with `VITE_` to expose to client: `import.meta.env.VITE_API_KEY`
- **No build tools configured**: No ESLint, Prettier, or testing framework
